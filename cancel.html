<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancel Appointment - Inked by Chris</title>
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twilio/4.7.2/twilio.min.js"></script>
    <style>
        .cancellation-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .cancel-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .keep-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .error-message {
            color: #dc3545;
            margin: 20px 0;
        }
        .success-message {
            color: #28a745;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="cancellation-container">
            <h1>Cancel Appointment</h1>
            <div id="cancellation-content">
                <p>Loading appointment details...</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("nqLDVniO3BUlQ-e1n");
        })();

        // Twilio configuration
        const TWILIO_ACCOUNT_SID = 'YOUR_ACCOUNT_SID'; // You'll need to replace this
        const TWILIO_AUTH_TOKEN = 'YOUR_AUTH_TOKEN';   // You'll need to replace this
        const TWILIO_PHONE_NUMBER = 'YOUR_TWILIO_NUMBER'; // You'll need to replace this

        // Function to format phone number
        function formatPhoneNumber(phone) {
            // Remove all non-numeric characters
            const cleaned = phone.replace(/\D/g, '');
            // Ensure it starts with country code
            return cleaned.startsWith('1') ? '+' + cleaned : '+1' + cleaned;
        }

        // Function to send SMS
        async function sendSMS(to, message) {
            try {
                const response = await fetch('https://api.twilio.com/2010-04-01/Accounts/' + TWILIO_ACCOUNT_SID + '/Messages.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(TWILIO_ACCOUNT_SID + ':' + TWILIO_AUTH_TOKEN)
                    },
                    body: new URLSearchParams({
                        'To': formatPhoneNumber(to),
                        'From': TWILIO_PHONE_NUMBER,
                        'Body': message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send SMS');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error sending SMS:', error);
                throw error;
            }
        }

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('id');
        const clientEmail = urlParams.get('email');
        const clientName = urlParams.get('name');
        const appointmentDate = urlParams.get('date');
        const appointmentTime = urlParams.get('time');
        const tattooType = urlParams.get('type');
        const tattooSize = urlParams.get('size');
        const tattooPlacement = urlParams.get('placement');
        const clientPhone = urlParams.get('phone');

        if (!bookingId || !clientEmail) {
            document.getElementById('cancellation-content').innerHTML = `
                <p class="error-message">Invalid cancellation link. Please check your email for the correct link or contact us at (651) 592-5122</p>
            `;
        } else {
            // Show confirmation dialog
            document.getElementById('cancellation-content').innerHTML = `
                <div class="cancellation-confirmation">
                    <p>Are you sure you want to cancel your appointment?</p>
                    <div class="cancellation-details">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        ${appointmentDate ? `<p><strong>Date:</strong> ${appointmentDate}</p>` : ''}
                        ${appointmentTime ? `<p><strong>Time:</strong> ${appointmentTime}</p>` : ''}
                    </div>
                    <div class="button-group">
                        <button onclick="cancelAppointment('${bookingId}', '${clientEmail}', '${clientName || ''}', '${appointmentDate || ''}', '${appointmentTime || ''}', '${tattooType || ''}', '${tattooSize || ''}', '${tattooPlacement || ''}', '${clientPhone || ''}')" class="cancel-btn">Yes, Cancel Appointment</button>
                        <button onclick="window.location.href='index.html'" class="keep-btn">No, Keep Appointment</button>
                    </div>
                </div>
            `;
        }

        async function cancelAppointment(bookingId, clientEmail, clientName, appointmentDate, appointmentTime, tattooType, tattooSize, tattooPlacement, clientPhone) {
            try {
                // Send cancellation SMS
                if (clientPhone) {
                    const cancellationSMS = `
Your appointment has been cancelled:
Date: ${appointmentDate}
Time: ${appointmentTime}

We hope to see you another time!
Questions? Call or text: (555) 555-5555`;

                    await sendSMS(clientPhone, cancellationSMS);
                }

                // Send cancellation notification to shop
                await emailjs.send('service_3pilkcs', 'template_gowinjb', {
                    to_name: 'Chris',
                    from_name: "Cancellation System",
                    reply_to: clientEmail,
                    booking_id: bookingId,
                    client_name: clientName,
                    appointment_date: appointmentDate,
                    appointment_time: appointmentTime,
                    tattoo_type: tattooType,
                    tattoo_size: tattooSize,
                    tattoo_placement: tattooPlacement
                });

                // Send cancellation confirmation to client
                await emailjs.send('service_3pilkcs', 'template_gowinjb', {
                    to_name: clientName,
                    from_name: "Inked by Chris",
                    reply_to: clientEmail,
                    message: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                        <h1 style="color: #333; margin: 0;">Appointment Cancellation</h1>
                        <p style="color: #666;">Booking ID: ${bookingId}</p>
                        
                        <div style="margin: 30px 0;">
                            <p>Dear ${clientName},</p>
                            
                            <p style="margin-bottom: 20px;">We understand that circumstances can change, and we want to thank you for letting us know about your cancellation. While we're sorry we won't be able to bring your tattoo vision to life at this time, we completely understand that timing is everything when it comes to getting inked.</p>
                            
                            <div style="background-color: #f8f8f8; padding: 20px; border-radius: 5px; margin: 20px 0;">
                                <h3 style="color: #333; margin-top: 0;">Cancelled Appointment Details:</h3>
                                <p>Date: ${appointmentDate}<br>
                                Time: ${appointmentTime}<br>
                                Tattoo Type: ${tattooType}<br>
                                Size: ${tattooSize}<br>
                                Placement: ${tattooPlacement}</p>
                            </div>
                            
                            <p>If you'd like to reschedule for a future date, please don't hesitate to:</p>
                            <ul style="list-style-type: none; padding-left: 0;">
                                <li> Call or text: (651) 592-5122</li>
                                <li> DM on Instagram: @inked_bychris</li>
                            </ul>
                            
                            <p>Thank you for choosing Inked by Chris. We hope to see you in the future!</p>
                        </div>
                        
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                            <p style="color: #888; font-size: 14px;">
                                Inked by Chris<br>
                                2395 7th St N<br>
                                Saint Paul, MN 55109<br>
                                (651) 592-5122
                            </p>
                        </div>
                    </div>
                    `
                });

                document.getElementById('cancellation-content').innerHTML = `
                    <div class="success-message">
                        <h2>Appointment Successfully Cancelled</h2>
                        <p>Your appointment has been cancelled. A confirmation email has been sent to your inbox.</p>
                        <p>If you'd like to book a new appointment:</p>
                        <ul>
                            <li>Call or text: (651) 592-5122</li>
                            <li>DM on Instagram: @inked_bychris</li>
                        </ul>
                        <a href="index.html" class="button">Return to Homepage</a>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to cancel appointment:', error);
                document.getElementById('cancellation-content').innerHTML = `
                    <div class="error-message">
                        <h2>Error</h2>
                        <p>Sorry, there was an error cancelling your appointment.</p>
                        <p>Please contact us at (651) 592-5122</p>
                        <p>Your booking ID is: ${bookingId}</p>
                        <div class="button-group">
                            <button onclick="window.location.href='index.html'" class="keep-btn">Return to Homepage</button>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
