<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cancel Appointment - Inked by Chris</title>
    <link rel="stylesheet" href="styles.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twilio/4.7.2/twilio.min.js"></script>
    <style>
        .cancellation-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        .cancel-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .keep-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .error-message {
            color: #dc3545;
            margin: 20px 0;
        }
        .success-message {
            color: #28a745;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="cancellation-container">
            <h1>Cancel Appointment</h1>
            <div id="cancellation-content">
                <p>Loading appointment details...</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("nqLDVniO3BUlQ-e1n");
        })();

        // Twilio configuration
        const TWILIO_ACCOUNT_SID = 'YOUR_ACCOUNT_SID'; // You'll need to replace this
        const TWILIO_AUTH_TOKEN = 'YOUR_AUTH_TOKEN';   // You'll need to replace this
        const TWILIO_PHONE_NUMBER = 'YOUR_TWILIO_NUMBER'; // You'll need to replace this

        // Function to format phone number
        function formatPhoneNumber(phone) {
            // Remove all non-numeric characters
            const cleaned = phone.replace(/\D/g, '');
            // Ensure it starts with country code
            return cleaned.startsWith('1') ? '+' + cleaned : '+1' + cleaned;
        }

        // Function to send SMS
        async function sendSMS(to, message) {
            try {
                const response = await fetch('https://api.twilio.com/2010-04-01/Accounts/' + TWILIO_ACCOUNT_SID + '/Messages.json', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(TWILIO_ACCOUNT_SID + ':' + TWILIO_AUTH_TOKEN)
                    },
                    body: new URLSearchParams({
                        'To': formatPhoneNumber(to),
                        'From': TWILIO_PHONE_NUMBER,
                        'Body': message
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to send SMS');
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error sending SMS:', error);
                throw error;
            }
        }

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const bookingId = urlParams.get('id');
        const clientEmail = urlParams.get('email');
        const clientName = urlParams.get('name');
        const appointmentDate = urlParams.get('date');
        const appointmentTime = urlParams.get('time');
        const tattooType = urlParams.get('type');
        const tattooSize = urlParams.get('size');
        const tattooPlacement = urlParams.get('placement');
        const clientPhone = urlParams.get('phone');

        if (!bookingId || !clientEmail) {
            document.getElementById('cancellation-content').innerHTML = `
                <p class="error-message">Invalid cancellation link. Please check your email for the correct link or contact us at (651) 592-5122</p>
            `;
        } else {
            // Show confirmation dialog
            document.getElementById('cancellation-content').innerHTML = `
                <div class="cancellation-confirmation">
                    <p>Are you sure you want to cancel your appointment?</p>
                    <div class="cancellation-details">
                        <p><strong>Booking ID:</strong> ${bookingId}</p>
                        ${appointmentDate ? `<p><strong>Date:</strong> ${appointmentDate}</p>` : ''}
                        ${appointmentTime ? `<p><strong>Time:</strong> ${appointmentTime}</p>` : ''}
                    </div>
                    <div class="button-group">
                        <button onclick="cancelAppointment('${bookingId}', '${clientEmail}', '${clientName || ''}', '${appointmentDate || ''}', '${appointmentTime || ''}', '${tattooType || ''}', '${tattooSize || ''}', '${tattooPlacement || ''}', '${clientPhone || ''}')" class="cancel-btn">Yes, Cancel Appointment</button>
                        <button onclick="window.location.href='index.html'" class="keep-btn">No, Keep Appointment</button>
                    </div>
                </div>
            `;
        }

        async function cancelAppointment(bookingId, clientEmail, clientName, appointmentDate, appointmentTime, tattooType, tattooSize, tattooPlacement, clientPhone) {
            try {
                // Send cancellation SMS
                if (clientPhone) {
                    const cancellationSMS = `
Your appointment has been cancelled:
Date: ${appointmentDate}
Time: ${appointmentTime}

We hope to see you another time!
Questions? Call or text: (555) 555-5555`;

                    await sendSMS(clientPhone, cancellationSMS);
                }

                // Send cancellation notification to shop
                await emailjs.send('service_3pilkcs', 'template_tukgt7p', {
                    to_name: "Chris",
                    from_name: "Cancellation System",
                    to_email: "senghakmad@gmail.com",
                    email_to: "senghakmad@gmail.com",
                    user_email: "senghakmad@gmail.com",
                    reply_to: clientEmail,
                    message: `
Appointment Cancellation Notice

Client Information:
- Booking ID: ${bookingId}
- Name: ${clientName || 'Not provided'}
- Email: ${clientEmail}

Cancelled Appointment Details:
- Date: ${appointmentDate || 'Not provided'}
- Time: ${appointmentTime || 'Not provided'}

Tattoo Details:
- Type: ${tattooType || 'Not provided'}
- Size: ${tattooSize || 'Not provided'}
- Placement: ${tattooPlacement || 'Not provided'}

This appointment has been cancelled by the client.
                    `
                }, 'nqLDVniO3BUlQ-e1n');

                // Send cancellation confirmation to client
                await emailjs.send('service_3pilkcs', 'template_gowinjb', {
                    to_name: "Client",
                    from_name: "Inked by Chris",
                    to_email: clientEmail,
                    email_to: clientEmail,
                    user_email: clientEmail,
                    reply_to: "senghakmad@gmail.com",
                    message: `
<div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
    <div style="text-align: center; padding: 20px 0;">
        <h1 style="color: #333; margin: 0;">Appointment Cancellation</h1>
        <p style="font-size: 18px; color: #666;">Inked by Chris</p>
    </div>

    <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0;">
        <p style="font-size: 16px; margin-bottom: 20px;">Dear valued client,</p>
        
        <p style="margin-bottom: 20px;">We understand that circumstances can change, and we want to thank you for letting us know about your cancellation. While we're sorry we won't be able to bring your tattoo vision to life at this time, we completely understand that timing is everything when it comes to getting inked.</p>

        <div style="background-color: white; padding: 20px; border-radius: 5px; margin: 20px 0;">
            <h2 style="color: #333; margin-top: 0; font-size: 18px;">Cancelled Appointment Details</h2>
            <p style="margin: 10px 0;">Booking ID: ${bookingId}</p>
            ${appointmentDate ? `<p style="margin: 10px 0;">Date: ${appointmentDate}</p>` : ''}
            ${appointmentTime ? `<p style="margin: 10px 0;">Time: ${appointmentTime}</p>` : ''}
            ${tattooType ? `<p style="margin: 10px 0;">Tattoo Type: ${tattooType}</p>` : ''}
            ${tattooSize ? `<p style="margin: 10px 0;">Tattoo Size: ${tattooSize}</p>` : ''}
            ${tattooPlacement ? `<p style="margin: 10px 0;">Tattoo Placement: ${tattooPlacement}</p>` : ''}
        </div>

        <div style="background-color: #fff3cd; padding: 20px; border-radius: 5px; margin: 20px 0;">
            <h2 style="color: #333; margin-top: 0; font-size: 18px;">Ready to Reschedule?</h2>
            <p style="margin-bottom: 15px;">When you're ready to make your tattoo dreams a reality, we'll be here. Your vision matters to us, and we'd be honored to work with you in the future.</p>
            <div style="text-align: center;">
                <a href="https://inkedbychris.com" 
                   style="background-color: #28a745; 
                          color: white; 
                          padding: 12px 25px; 
                          text-decoration: none; 
                          border-radius: 5px; 
                          display: inline-block;
                          font-weight: bold;">
                    Book New Appointment
                </a>
            </div>
        </div>

        <div style="background-color: white; padding: 20px; border-radius: 5px; margin: 20px 0;">
            <h2 style="color: #333; margin-top: 0; font-size: 18px;">Stay Connected</h2>
            <p style="margin-bottom: 15px;">Follow us on social media to stay inspired and see our latest work. When you're ready for your next tattoo journey, we'll be here to help bring your vision to life.</p>
            <ul style="list-style: none; padding: 0; margin: 0;">
                <li style="margin: 8px 0;">✨ Every tattoo tells a story</li>
                <li style="margin: 8px 0;">✨ Your vision is worth waiting for</li>
                <li style="margin: 8px 0;">✨ We're here when you're ready</li>
            </ul>
        </div>
    </div>

    <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
        <p style="color: #666; margin-bottom: 5px;">Questions? Contact us at:</p>
        <p style="color: #666; margin-top: 0;">
            Email: senghakmad@gmail.com<br>
            Location: 2395 7th St N, Saint Paul, MN 55109
        </p>
        <p style="color: #666; font-size: 12px; margin-top: 20px;">
            2025 Inked by Chris. All rights reserved.
        </p>
    </div>
</div>`,
                    html_message: true
                }, 'nqLDVniO3BUlQ-e1n');

                // Show success message
                document.getElementById('cancellation-content').innerHTML = `
                    <div class="success-message">
                        <h2>Appointment Cancelled</h2>
                        <p>We understand that timing is everything when it comes to getting inked.</p>
                        <p>A confirmation email has been sent to ${clientEmail}.</p>
                        <p>When you're ready to make your tattoo dreams a reality, we'll be here waiting to help bring your vision to life.</p>
                        <div class="button-group">
                            <button onclick="window.location.href='index.html'" class="keep-btn">Return to Homepage</button>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to cancel appointment:', error);
                document.getElementById('cancellation-content').innerHTML = `
                    <div class="error-message">
                        <h2>Error</h2>
                        <p>Sorry, there was an error cancelling your appointment.</p>
                        <p>Please contact us at senghakmad@gmail.com</p>
                        <p>Your booking ID is: ${bookingId}</p>
                        <div class="button-group">
                            <button onclick="window.location.href='index.html'" class="keep-btn">Return to Homepage</button>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
